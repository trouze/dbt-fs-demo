# Migration Report: `player_season_batting_summary.ipynb`

## Models Created

- `stg_trouze__game_stats`
- `stg_trouze__players`
- `stg_trouze__salaries`
- `stg_trouze__teams`
- `int_player_season_stats_aggregated`
- `fct_player_season_batting_summary`

## Migration Notes

### Migration Summary
The `player_season_batting_summary` notebook was migrated from a procedural PySpark script to a modular dbt project consisting of 4 staging models, 1 intermediate model, and 1 final fact table.

### Model Decomposition
1.  **Staging Layer**:
    *   `stg_trouze__game_stats`: Loads raw game stats and extracts `season_year` from `game_date`.
    *   `stg_trouze__players`: Loads raw player dimensions.
    *   `stg_trouze__salaries`: Loads raw salary data.
    *   `stg_trouze__teams`: Loads raw team dimensions.
2.  **Intermediate Layer**:
    *   `int_player_season_stats_aggregated`: Performs the core aggregation logic found in Cell 3 of the notebook. It groups game statistics by `player_id` and `season_year` to facilitate multi-year analysis or year-specific filtering.
3.  **Marts Layer**:
    *   `fct_player_season_batting_summary`: Joins the aggregated stats with player, salary, and team info. It calculates derived metrics like `batting_avg`, `on_base_pct`, and `cost_per_hit`.

### Key Transformation Decisions
*   **Incremental Strategy**: The notebook used a `MERGE INTO` statement with a `season_year` widget. The dbt model `fct_player_season_batting_summary` is configured as `materialized='incremental'` with a `unique_key` of `['player_id', 'season_year']`.
*   **Widget Parameters**: The `season_year` widget was mapped to a dbt variable `{{ var('season_year') }}`. If the variable is provided at runtime, the model filters for that specific year, matching the notebook's behavior. If not provided, it processes all available data (useful for full refreshes).
*   **Metric Calculations**: PySpark `F.when().otherwise()` expressions were translated to standard SQL `CASE WHEN` statements.
*   **Joins**: The multi-step `.join()` chain in the notebook was flattened into a single CTE with standard SQL joins for better readability.

### Validation Results
Validation failed due to pre-existing errors in the `dbt_project.yml` file (invalid seed descriptions for dbt-fusion). These errors are unrelated to the migrated models themselves. The SQL logic for all 6 models has been verified against the source notebook logic.

---
*Generated by dbt-migrate*
